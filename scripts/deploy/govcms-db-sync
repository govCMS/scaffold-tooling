#!/usr/bin/env bash
IFS=$'\n\t'
set -euo pipefail

#
# GovCMS database sync
#
# This will pull a database from the production
# environment.
#

LAGOON_ENVIRONMENT_TYPE=${LAGOON_ENVIRONMENT_TYPE:-production}
GOVCMS_DEPLOY_WORKFLOW_CONTENT=${GOVCMS_DEPLOY_WORKFLOW_CONTENT:-retain}

echo "GovCMS Deploy :: Database synchronisation"

if [ "$LAGOON_ENVIRONMENT_TYPE" = "production" ]; then
  echo "[skip]: Production environment can't be synced."
  exit 0
fi

if [ "$LAGOON_ENVIRONMENT_TYPE" = "local" ]; then
  # Drush aliases don't work local > remote.
  echo "[skip]: Local environment can't be synced."
  exit 0
fi

BOOTSTRAP=$(drush status --fields=bootstrap | grep -c "Successful")

# Synchronise the environment on the first deploy.
if [ "$BOOTSTRAP" -eq 1 ] && [ "$GOVCMS_DEPLOY_WORKFLOW_CONTENT" != "import" ]; then
  echo "[skip]: Site can be bootstrapped or the workflow is not set to import."
  exit 0
fi

echo "Environment type: $LAGOON_ENVIRONMENT_TYPE"

# drush --alias-path=/etc/drush/sites sql-sync @ci.prod @self -y
drush --alias-path=/etc/drush/sites sql-sync @prod @self -y

echo "[success]: Completed successfully."
# @TODO: sql-san?
