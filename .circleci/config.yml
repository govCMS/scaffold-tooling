version: 2
jobs:
  build:
    docker:
      - image: quay.io/govcms/govcms-ci
    steps:
      - checkout
      - setup_remote_docker
      - run: composer validate --strict || true
      - run: .circleci/shellcheck.sh || true
      - run: .circleci/phpcs.sh || true

      # govcms/scaffold-tooling is a composer package which is somewhat
      # coupled with GovCMS/Lagoon. So this is an integration test for
      # to replicate how composer builds govcms (eg. 'composer create-project ...').
      # First we build a govcms docker environment (CLI and DB only)
      # without installing Drupal.
      # Then inside the CLI container we modify the composer.json to reference
      # our new code and use this code to install and run Drupal, thus testing
      # the scaffold.

      - run:
          name: Start amazeeio-network
          command: docker network prune -f && docker network inspect amazeeio-network >/dev/null || docker network create amazeeio-network
      - run:
          name: Setup, docker build
          command: |
            git checkout -b latest-package-"${CIRCLE_SHA1}"
            touch /home/project/latest-package
            git clone https://github.com/govCMS/govCMS8-scaffold-paas /var/govcms
            cd /var/govcms
            docker-compose up -d mariadb
            docker-compose up -d cli
            docker cp /home/project "$(docker-compose ps -q cli)":/var/latest-package
      - run:
          name: Rebuild composer with new code.
          working_directory: /var/govcms
          command: |
            docker-compose exec -T cli bash -c 'ls'
            docker-compose exec -T cli bash -c 'composer -n -d /app config repositories.test path /var/latest-package'
            docker-compose exec -T cli bash -c 'composer -n -d /app require govcms/govcms:dev-latest-package-"'"${CIRCLE_SHA1}"'" --ignore-platform-reqs'
      - run:
          name: Install site
          working_directory: /var/govcms
          command: ahoy -v install -- install_configure_form.enable_update_status_module=NULL install_configure_form.enable_update_status_emails=NULL
      - run:
          name: Lint code
          working_directory: /var/govcms
          command: ahoy -v lint || true
      - run:
          name: Run Behat tests with rerun
          working_directory: /var/govcms
          command: ahoy test-behat -- --format=progress_fail || ahoy test-behat -- --format=progress_fail --rerun
