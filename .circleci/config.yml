version: 2
jobs:
  build:
    docker:
      - image: quay.io/govcms/govcms-ci
    steps:
      - checkout
      - run: composer validate --strict || true
      - run: .circleci/shellcheck.sh || true
      - run: .circleci/phpcs.sh || true
      - run:
          name: Start amazeeio-network
          command: docker network prune -f && docker network inspect amazeeio-network >/dev/null || docker network create amazeeio-network
      - run:
          name: Prepare the workspace with scaffold project
          command: |
            composer create-project -n --no-install --repository=https://satis.govcms.gov.au/projects govCMS/govCMS-project:dev-paas-wip /var/govcms
            git checkout -b latest-distro-package-"${CIRCLE_SHA1}"
            cp -r "${CIRCLE_WORKING_DIRECTORY}" "/var/govcms/latest-distro-package"
            composer -n require govcms/govcms:dev-latest-distro-package-"'"${CIRCLE_SHA1}"'"
      - run:
          name: Docker build
          working_directory: /var/govcms
          command: |
            docker-compose up -d mariadb
            docker-compose up -d cli

            ls -la
            ls -la /app
            ls -la /var/govcms
            # docker-compose ps
            # ahoy -v build
            docker-compose exec -T cli sh -c 'ls -la /app'
            docker-compose ps
workflows:
  version: 2
  main:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
            branches:
              only: /.*/